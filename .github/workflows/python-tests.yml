name: Evaluación Automática

on: [push, pull_request]

env:
  TALLER_NOMBRE: "ejercicio1"  
  TESTS_REPO: "test-privado-taller1"  

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install jupyter nbconvert ipykernel nbformat
        python -m ipykernel install --user --name=python3

    - name: Configuración de tests
      run: |
        mkdir -p ~/.ssh
        cat > ~/.ssh/id_ed25519 << 'EOF'
        ${{ secrets.TEST_OCULTOS }}
        EOF
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan github.com >> ~/.ssh/known_hosts

    - name: Descarga de tests
      run: |
        git clone git@github.com:Procesamiento-de-Lenguaje-Natural/${{ env.TESTS_REPO }}.git temp_repo
        mkdir -p tests
        cp temp_repo/pruebas/test_*.py tests/ 2>/dev/null || echo "No se encontraron algunos archivos de test"
        ls -la tests/
        rm -rf temp_repo

    - name: Ejecución de notebook ejercicio 1
      run: |
        jupyter nbconvert --to notebook --execute notebooks/${{ env.TALLER_NOMBRE }}.ipynb \
          --output ${{ env.TALLER_NOMBRE }}_executed.ipynb \
          --ExecutePreprocessor.kernel_name=python3 \
          --ExecutePreprocessor.timeout=300 \
          --ExecutePreprocessor.allow_errors=true

    - name: Ejecución de tests de evaluación
      run: |
        echo "Ejecutando tests de evaluación..."
        PYTHONPATH=$PYTHONPATH:$(pwd):$(pwd)/data pytest tests/ -v --tb=short
        
    - name: Resultado de la evaluación
      if: always()
      run: |
        echo "Evaluación completada. Revisa los resultados arriba."